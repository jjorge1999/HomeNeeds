<aside 
  id="app-sidebar" 
  [class]="sidebarCollapsed() ? 'sidebar sidebar-collapsed' : 'sidebar sidebar-expanded'"
>
  <!-- Collapse Toggle Button -->
  <button 
    id="sidebar-toggle"
    (click)="toggleSidebar()"
    class="absolute -right-3 top-6 z-10 w-6 h-6 bg-primary rounded-full flex items-center justify-center shadow-lg hover:bg-primary-hover transition-all"
    [title]="sidebarCollapsed() ? 'Expand sidebar' : 'Collapse sidebar'"
  >
    <span class="material-symbols-outlined text-white text-sm" style="font-size: 16px;">
      {{ sidebarCollapsed() ? 'chevron_right' : 'chevron_left' }}
    </span>
  </button>

  <div>
    <!-- Logo Section -->
    <div class="flex flex-col mb-8">
      <div class="flex items-center gap-2 mb-1">
        <span class="material-symbols-outlined text-primary" style="font-size: 32px;">checklist</span>
        @if (!sidebarCollapsed()) {
          <h1 class="text-2xl font-extrabold tracking-tight whitespace-nowrap">HomeNeeds</h1>
        }
      </div>
      @if (!sidebarCollapsed()) {
        <p class="text-sm text-slate-500 dark:text-text-muted">Manage your home effortlessly</p>
      }
    </div>
        <!-- User Profile -->
    <div 
      id="user-profile" 
      [class]="sidebarCollapsed() ? 'flex items-center justify-center p-2 rounded-full bg-surface-dark cursor-pointer hover:bg-border-dark transition-colors' : 'flex items-center gap-3 p-4 rounded-full bg-surface-dark cursor-pointer hover:bg-border-dark transition-colors'"
    >
      <img 
        alt="User avatar" 
        class="w-8 h-8 rounded-full object-cover" 
        [src]="currentUser()?.avatarUrl || 'https://ui-avatars.com/api/?name=Guest&background=random'"
        [title]="currentUser()?.name || 'Guest'"
      />
      @if (!sidebarCollapsed()) {
        <div class="flex flex-col">
          <span class="text-sm font-bold text-white leading-none">{{ currentUser()?.name || 'Guest' }}</span>
          <span class="text-[10px] text-text-muted capitalize">{{ currentUser()?.role || 'Visitor' }}</span>
        </div>
      }
    </div>
    <br>
    <hr style="border-color: #54585e;">
    <br>

    <!-- Navigation -->
    <nav id="main-nav" class="flex flex-col gap-2">
      <a 
        id="nav-overview" 
        routerLink="/overview" 
        routerLinkActive="bg-primary/10 text-primary-hover dark:text-primary" 
        [class]="sidebarCollapsed() ? 'nav-item nav-item-collapsed' : 'nav-item'"
        [title]="sidebarCollapsed() ? 'Overview' : ''"
      >
        <span class="material-symbols-outlined filled">dashboard</span>
        @if (!sidebarCollapsed()) {
          <span class="font-bold text-sm">Overview</span>
        }
      </a>
      <a 
        id="nav-groceries" 
        routerLink="/groceries" 
        routerLinkActive="bg-primary/10 text-primary-hover dark:text-primary" 
        [class]="sidebarCollapsed() ? 'nav-item nav-item-collapsed' : 'nav-item'"
        [title]="sidebarCollapsed() ? 'Groceries' : ''"
      >
        <span class="material-symbols-outlined group-hover:text-slate-900 dark:group-hover:text-white transition-colors">shopping_cart</span>
        @if (!sidebarCollapsed()) {
          <span class="font-medium text-sm group-hover:text-slate-900 dark:group-hover:text-white transition-colors">Groceries</span>
        }
      </a>
      <a 
        id="nav-users" 
        routerLink="/users" 
        routerLinkActive="bg-primary/10 text-primary-hover dark:text-primary" 
        [class]="sidebarCollapsed() ? 'nav-item nav-item-collapsed' : 'nav-item'"
        [title]="sidebarCollapsed() ? 'Users' : ''"
      >
        <span class="material-symbols-outlined group-hover:text-slate-900 dark:group-hover:text-white transition-colors">group</span>
        @if (!sidebarCollapsed()) {
          <span class="font-medium text-sm group-hover:text-slate-900 dark:group-hover:text-white transition-colors">Users</span>
        }
      </a>
      <button 
        id="nav-logout" 
        (click)="logout()" 
        [class]="sidebarCollapsed() ? 'nav-item nav-item-collapsed text-left mt-auto' : 'nav-item text-left mt-auto'"
        [title]="sidebarCollapsed() ? 'Log Out' : ''"
      >
        <span class="material-symbols-outlined group-hover:text-red-500 dark:group-hover:text-red-400 transition-colors">logout</span>
        @if (!sidebarCollapsed()) {
          <span class="font-medium text-sm group-hover:text-red-500 dark:group-hover:text-red-400 transition-colors">Log Out</span>
        }
      </button>
    </nav>
      <!-- Bottom Section (Stats & User Profile) -->
  <div class="flex flex-col gap-4 mt-8">
    @if (!sidebarCollapsed()) {
      <!-- Stats Card - Only show when expanded -->
      <div id="stats-card" class="p-5 rounded-2xl bg-surface-dark/40 border border-border-dark backdrop-blur-sm">
        <div class="flex justify-between items-start mb-2">
          <span class="material-symbols-outlined text-text-muted">pending_actions</span>
          <span class="text-xs font-bold text-primary bg-primary/10 px-2 py-1 rounded-full">Today</span>
        </div>
        <p class="text-3xl font-black text-white leading-tight mb-1">{{ pendingItemsCount() }}</p>
        <p class="text-xs text-text-muted font-medium">Items Pending</p>
      </div>
    } @else {
      <!-- Collapsed Stats - Just show count -->
      <div class="flex flex-col items-center p-2 rounded-xl bg-surface-dark/40 border border-border-dark" title="Items Pending">
        <span class="material-symbols-outlined text-text-muted text-sm">pending_actions</span>
        <span class="text-lg font-bold text-white">{{ pendingItemsCount() }}</span>
      </div>
    }
  </div>
  </div>
</aside>
<div class="flex-1 h-screen flex flex-col overflow-hidden">
  <router-outlet></router-outlet>
</div>
<app-dialog></app-dialog>
<app-loading></app-loading>

<!-- Global Login Overlay -->
@if (!currentUser() && !loading()) {
<div class="fixed inset-0 z-[100] bg-[#111317] flex items-center justify-center p-4">
    <div class="max-w-4xl w-full flex flex-col items-center gap-12 animate-in fade-in zoom-in duration-300">
        <div class="text-center space-y-2">
           <h1 class="text-4xl font-bold text-white tracking-tight">Welcome Back</h1>
           <p class="text-[#9ea7b7] text-lg">Who is using HomeNeeds?</p>
        </div>

        @if (loginStep() === 'select') {
        <!-- User Grid -->
        <div class="flex flex-wrap justify-center gap-8">
            @for (user of allUsers(); track user.id) {
                <button (click)="selectUser(user)" class="group flex flex-col items-center gap-4 transition-transform hover:scale-105 outline-none focus:scale-105">
                    <div class="size-24 rounded-full border-2 border-[#292e38] group-hover:border-[#2060df] overflow-hidden transition-colors relative">
                        <img [src]="user.avatarUrl || 'https://ui-avatars.com/api/?name=' + user.name + '&background=random'" class="w-full h-full object-cover">
                        @if (user.password) {
                             <div class="absolute inset-0 bg-black/40 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                                <span class="material-symbols-outlined text-white">lock</span>
                             </div>
                        }
                    </div>
                    <span class="text-lg font-medium text-[#9ea7b7] group-hover:text-white transition-colors">{{ user.name }}</span>
                </button>
            }
        </div>
        } @else {
        <!-- Password Prompt -->
        <div class="bg-[#1a202e] border border-[#292e38] rounded-2xl p-8 w-full max-w-sm shadow-2xl animate-in zoom-in-95 duration-200">
             <div class="flex flex-col items-center gap-4 mb-6">
                 <div class="size-16 rounded-full border border-[#292e38] overflow-hidden">
                     <img [src]="selectedUser()?.avatarUrl || 'https://ui-avatars.com/api/?name=' + selectedUser()?.name + '&background=random'" class="w-full h-full object-cover">
                 </div>
                 <h3 class="text-white font-bold text-xl">{{ selectedUser()?.name }}</h3>
             </div>
             
             <div class="space-y-4">
                 <div>
                    <input [value]="passwordInput()" (input)="passwordInput.set($any($event.target).value)" (keyup.enter)="verifyLogin()" type="password" class="w-full bg-[#111317] border border-[#292e38] rounded-lg px-4 py-3 text-white focus:outline-none focus:border-[#2060df] focus:ring-1 focus:ring-[#2060df] transition-all text-center placeholder-[#586173]" placeholder="Enter Password" autofocus>
                    @if (loginError()) {
                        <p class="text-red-400 text-xs mt-2 text-center">{{ loginError() }}</p>
                    }
                 </div>
                 <button (click)="verifyLogin()" class="w-full py-3 rounded-lg bg-[#2060df] text-white font-bold hover:bg-[#2060df]/90 transition-colors">Login</button>
                 <button (click)="cancelPassword()" class="w-full py-3 rounded-lg border border-[#3b4250] text-[#9ea7b7] font-bold hover:text-white hover:border-white transition-colors">Back</button>
             </div>
        </div>
        }
    </div>
</div>
}
